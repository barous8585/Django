<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historique - Commer√ßant</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Navigation -->
        <nav class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-4 shadow-lg">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-2xl font-bold">üì¶ Tontine Digitale</h1>
                <div class="flex gap-4">
                    <a href="/commercant/dashboard/" class="hover:bg-blue-700 px-4 py-2 rounded transition">üìä Dashboard</a>
                    <a href="/commercant/participer/" class="hover:bg-blue-700 px-4 py-2 rounded transition">‚ûï Participer</a>
                    <a href="/commercant/historique/" class="bg-blue-700 px-4 py-2 rounded">üìú Historique</a>
                    <a href="/commercant/profil/" class="hover:bg-blue-700 px-4 py-2 rounded transition">üë§ Profil</a>
                    <a href="/logout/" class="hover:bg-red-600 px-4 py-2 rounded transition">üö™ D√©connexion</a>
                </div>
            </div>
        </nav>

        <!-- Contenu Principal -->
        <div class="container mx-auto p-8">
            <div class="bg-white rounded-lg shadow-xl p-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">üìú Historique de mes Participations & Commandes</h2>
                
                <!-- Filtres -->
                <div class="mb-6 flex gap-4">
                    <div>
                        <label class="block text-gray-600 mb-2">Type</label>
                        <select id="filterType" class="border-2 border-gray-300 rounded-lg p-2 focus:border-blue-500">
                            <option value="all">Tout</option>
                            <option value="participations">Participations</option>
                            <option value="commandes">Commandes</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-600 mb-2">Statut</label>
                        <select id="filterStatut" class="border-2 border-gray-300 rounded-lg p-2 focus:border-blue-500">
                            <option value="all">Tous</option>
                            <option value="valide">‚úÖ Valid√©</option>
                            <option value="attente">‚è≥ En attente</option>
                            <option value="en_cours">üîÑ En cours</option>
                        </select>
                    </div>
                </div>

                <!-- Tableau des Participations -->
                <div id="participationsSection" class="mb-8">
                    <h3 class="text-2xl font-bold text-gray-700 mb-4">üí∞ Mes Participations</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                            <thead class="bg-blue-100">
                                <tr>
                                    <th class="py-3 px-4 text-left">#</th>
                                    <th class="py-3 px-4 text-left">Conteneur</th>
                                    <th class="py-3 px-4 text-left">Montant</th>
                                    <th class="py-3 px-4 text-left">R√©f√©rence</th>
                                    <th class="py-3 px-4 text-left">Statut</th>
                                    <th class="py-3 px-4 text-left">Date</th>
                                    <th class="py-3 px-4 text-left">Preuve</th>
                                </tr>
                            </thead>
                            <tbody id="participationsTable">
                                <tr><td colspan="7" class="text-center py-8 text-gray-400">Chargement...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tableau des Commandes -->
                <div id="commandesSection">
                    <h3 class="text-2xl font-bold text-gray-700 mb-4">üì¶ Mes Commandes</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                            <thead class="bg-green-100">
                                <tr>
                                    <th class="py-3 px-4 text-left">#</th>
                                    <th class="py-3 px-4 text-left">Description</th>
                                    <th class="py-3 px-4 text-left">Cat√©gorie</th>
                                    <th class="py-3 px-4 text-left">Volume</th>
                                    <th class="py-3 px-4 text-left">Prix Achat</th>
                                    <th class="py-3 px-4 text-left">Total</th>
                                    <th class="py-3 px-4 text-left">Statut</th>
                                    <th class="py-3 px-4 text-left">Date</th>
                                </tr>
                            </thead>
                            <tbody id="commandesTable">
                                <tr><td colspan="8" class="text-center py-8 text-gray-400">Chargement...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Statistiques -->
                <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-blue-50 p-6 rounded-lg border-2 border-blue-200">
                        <p class="text-blue-600 text-sm font-semibold">Total Participations</p>
                        <p class="text-3xl font-bold text-blue-800" id="totalParticipations">-</p>
                    </div>
                    <div class="bg-green-50 p-6 rounded-lg border-2 border-green-200">
                        <p class="text-green-600 text-sm font-semibold">Total Commandes</p>
                        <p class="text-3xl font-bold text-green-800" id="totalCommandes">-</p>
                    </div>
                    <div class="bg-purple-50 p-6 rounded-lg border-2 border-purple-200">
                        <p class="text-purple-600 text-sm font-semibold">Montant Total Investi</p>
                        <p class="text-3xl font-bold text-purple-800" id="montantTotal">-</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Charger les participations
        async function loadParticipations() {
            try {
                const response = await axios.get('/api/participations/?format=json');
                const participations = response.data;
                const tbody = document.getElementById('participationsTable');
                
                if (participations.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-400">Aucune participation pour le moment</td></tr>';
                    return;
                }

                tbody.innerHTML = participations.map(p => `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="py-3 px-4">${p.id}</td>
                        <td class="py-3 px-4 font-semibold">${p.conteneur_nom || 'Conteneur #' + p.conteneur}</td>
                        <td class="py-3 px-4 text-green-600 font-bold">${parseFloat(p.montant).toLocaleString()} GNF</td>
                        <td class="py-3 px-4 text-sm text-gray-600">${p.reference_paiement}</td>
                        <td class="py-3 px-4">
                            ${p.valide ? '<span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">‚úÖ Valid√©</span>' : '<span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-semibold">‚è≥ En attente</span>'}
                        </td>
                        <td class="py-3 px-4 text-sm">${new Date(p.date_creation).toLocaleDateString('fr-FR')}</td>
                        <td class="py-3 px-4">
                            ${p.preuve_paiement ? '<a href="' + p.preuve_paiement + '" target="_blank" class="text-blue-600 hover:underline">üì∑ Voir</a>' : '‚Äî'}
                        </td>
                    </tr>
                `).join('');

                // Calculer le total
                const totalMontant = participations.reduce((sum, p) => sum + parseFloat(p.montant), 0);
                document.getElementById('totalParticipations').textContent = `${totalMontant.toLocaleString()} GNF`;
            } catch (error) {
                console.error('Erreur chargement participations:', error);
                document.getElementById('participationsTable').innerHTML = '<tr><td colspan="7" class="text-center py-8 text-red-500">Erreur de chargement</td></tr>';
            }
        }

        // Charger les commandes (√† impl√©menter c√¥t√© API)
        async function loadCommandes() {
            try {
                // TODO: Cr√©er l'endpoint API pour les commandes du commer√ßant connect√©
                document.getElementById('commandesTable').innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-400">Fonctionnalit√© en cours de d√©veloppement</td></tr>';
                document.getElementById('totalCommandes').textContent = '0 GNF';
            } catch (error) {
                console.error('Erreur chargement commandes:', error);
            }
        }

        // Calculer le total investi
        function calculateTotal() {
            const totalPart = parseFloat(document.getElementById('totalParticipations').textContent.replace(/\s/g, '')) || 0;
            const totalCmd = parseFloat(document.getElementById('totalCommandes').textContent.replace(/\s/g, '')) || 0;
            document.getElementById('montantTotal').textContent = `${(totalPart + totalCmd).toLocaleString()} GNF`;
        }

        // Filtres
        document.getElementById('filterType').addEventListener('change', function() {
            const value = this.value;
            if (value === 'all') {
                document.getElementById('participationsSection').classList.remove('hidden');
                document.getElementById('commandesSection').classList.remove('hidden');
            } else if (value === 'participations') {
                document.getElementById('participationsSection').classList.remove('hidden');
                document.getElementById('commandesSection').classList.add('hidden');
            } else {
                document.getElementById('participationsSection').classList.add('hidden');
                document.getElementById('commandesSection').classList.remove('hidden');
            }
        });

        // Charger les donn√©es au chargement de la page
        Promise.all([loadParticipations(), loadCommandes()]).then(calculateTotal);
    </script>
</body>
</html>
